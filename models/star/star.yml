version: 2

models:

  - name: dim_clients
    description: "Dimension table containing client-level attributes and first-touch attribution data. Captures the first event for each client including landing page, referrer, UTM parameters, and device information. Also includes client lifecycle metrics such as last event timestamp, checkout completion status, and first checkout completed session number."
    columns:
      - name: client_id
        description: "Unique identifier for each client"
        data_tests:
          - not_null
          - unique
      - name: first_event_timestamp
        description: "Timestamp of the client's first event"
        data_tests:
          - not_null
      - name: last_event_timestamp
        description: "Timestamp of the client's most recent event"
        data_tests:
          - not_null
      - name: has_completed_checkout
        description: "Binary flag indicating if client has completed a checkout"
        data_tests:
          - accepted_values:
              values: [0, 1]
              config:
                severity: warn
    data_tests:
      - dbt_utils.expression_is_true:
          expression: "last_event_timestamp >= first_event_timestamp"
          config:
            severity: warn

  - name: fct_client_journey
    description: "Fact table tracking the client journey through key conversion milestones. Records timestamps for each client's progression through the funnel: page viewed, product added to cart, checkout started, and checkout completed events."
    columns:
      - name: client_id
        description: "Unique identifier for each client"
        data_tests:
          - not_null
          - unique
      - name: page_viewed_at
        description: "Timestamp when client first viewed a page"
        data_tests:
          - not_null:
              severity: warn
      - name: product_added_to_cart_at
        description: "Timestamp when client first added a product to cart"
      - name: checkout_started_at
        description: "Timestamp when client first started checkout"
      - name: checkout_completed_at
        description: "Timestamp when client first completed checkout"
      - name: minutes_page_view_to_cart
        description: "Minutes between page view and cart add"
      - name: minutes_cart_to_checkout_start
        description: "Minutes between cart add and checkout start"
      - name: minutes_checkout_start_to_complete
        description: "Minutes between checkout start and completion"
    # data_tests:
    #   - dbt_utils.expression_is_true:
    #       expression: "product_added_to_cart_at IS NULL OR product_added_to_cart_at >= page_viewed_at"
    #       config:
    #         severity: warn
    #   - dbt_utils.expression_is_true:
    #       expression: "checkout_started_at IS NULL OR checkout_started_at >= COALESCE(product_added_to_cart_at, page_viewed_at)"
    #       config:
    #         severity: warn
    #   - dbt_utils.expression_is_true:
    #       expression: "checkout_completed_at IS NULL OR checkout_completed_at >= COALESCE(checkout_started_at, product_added_to_cart_at, page_viewed_at)"
    #       config:
    #         severity: warn
    #   - dbt_utils.expression_is_true:
    #       expression: "minutes_page_view_to_cart IS NULL OR minutes_page_view_to_cart >= 0"
    #       config:
    #         severity: warn
    #   - dbt_utils.expression_is_true:
    #       expression: "minutes_cart_to_checkout_start IS NULL OR minutes_cart_to_checkout_start >= 0"
    #       config:
    #         severity: warn
    #   - dbt_utils.expression_is_true:
    #       expression: "minutes_checkout_start_to_complete IS NULL OR minutes_checkout_start_to_complete >= 0"
    #       config:
    #         severity: warn

  - name: fct_client_metrics
    description: "Fact table containing aggregated client-level metrics including total events, total sessions, total revenue, days active (calculated from first to last event), and total number of checkouts completed per client."
    columns:
      - name: client_id
        description: "Unique identifier for each client"
        data_tests:
          - not_null
          - unique
      - name: total_events
        description: "Total number of events for the client"
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "> 0"
              config:
                severity: warn
      - name: total_sessions
        description: "Total number of sessions for the client"
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "> 0"
              config:
                severity: warn
      - name: total_revenue
        description: "Total revenue generated by the client"
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              config:
                severity: warn
      - name: days_active
        description: "Number of days between first and last event"
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              config:
                severity: warn
      - name: total_checkouts_completed
        description: "Total number of checkouts completed by the client"
        # data_tests:
        #   - dbt_utils.expression_is_true:
        #       expression: "total_checkouts_completed IS NULL OR total_checkouts_completed >= 0"
        #       config:
        #         severity: warn
    # data_tests:
    #   - dbt_utils.expression_is_true:
    #       expression: "total_sessions <= total_events"
    #       config:
    #         severity: warn
    #   - dbt_utils.expression_is_true:
    #       expression: "total_checkouts_completed IS NULL OR total_checkouts_completed <= total_events"
    #       config:
    #         severity: warn
